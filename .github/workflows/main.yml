name: Deploy to Production

# –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–∞ –∫–∞–∂–¥—ã–π –ø—É—à –≤ –≤–µ—Ç–∫—É main
on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: üöÄ Deploy
    runs-on: ubuntu-latest

    steps:
      # 1) –ö–ª–æ–Ω–∏—Ä—É–µ–º –≤–∞—à—É —Ä–µ–ø—É
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2) –ó–∞–ø—É—Å–∫–∞–µ–º ssh-–∞–≥–µ–Ω—Ç –∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –∏–∑ Secrets
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.PROD_SSH_PRIVATE_KEY }}

      # 3) –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –ø–æ SSH –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ –¥–µ–ª–∞–µ–º –¥–µ–ø–ª–æ–π
      - name: Deploy over SSH
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ secrets.PROD_SERVER_IP }} << 'EOF'
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            cd /root/docker-compose

            # –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º —Å–≤–µ–∂–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            git pull origin main

            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            docker-compose down

            # –ó–∞–ø—É—Å–∫–∞–µ–º —Å –ø–µ—Ä–µ—Å–±–æ—Ä–∫–æ–π
            docker-compose up -d --build
          EOF
